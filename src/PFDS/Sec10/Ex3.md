# 演習問題 10.3

> ブートストラップキューの `tail (snoc (q, x))` において `tail` と `snoc` の両方が中で `snoc` を呼ぶことがないことを示せ。

## 方針

- snoc が中で snoc を呼ぶ場合、snoc (q, x) がどのような制約を満たすキューとなるかを示す
- 外側の tail が中で snoc を呼ぶときの、tail に渡されるキューの制約を示す
- tail (snoc (q, x)) において、上記の制約を両方同時に満たすようなキュー q が存在しないことを示す

## snoc が中で snoc を呼ぶ場合のキューの制約

snoc パターン 2 → checkQ パターン 2 の順にマッチすることが必要となる。

このとき、

- snoc パターン 2 にマッチする→キューは空でない、lenr は lenr+1 に更新
- checkQ パターン 2 にマッチする→ lenfm < lenr

であり、最初の時点で不変条件を満たすならば、キューは空でないことから、f は少なくとも 1 つの要素を持つ（空キューに snoc される場合はもちろん、それ以外の場合は checkF パターン 2 によって f が要素を持つことが強制される）。

そのため、checkQ パターン 2 の次は checkF パターン 3 にマッチする。

最終的に得られるキュー Q lenfm f m lenr r は、

- lenfm >= 3 (|f| >= 1 かつ lenfm < lenr かつ lenfm < lenr)
- |f| >= 1
- lenr == 0

を満たす。

## tail が中で snoc を呼ぶ条件

tail パターン 2 → checkQ パターン 2 の順にマッチすることが必要となる。

このとき、

- tail パターン 2 にマッチする→ |f| >= 1, lenfm は lenfm-1 に更新
- checkQ パターン 2 にマッチする→ lenfm < lenr

であり、 tail で先頭要素が失われることから、|f| >= 0 となり、 lenr >= 1 となる。

すなわち、 snoc が中で呼ばれる条件の 1 つが lenr >= 1 である。

## snoc が中で snoc を呼ぶ場合、tail は snoc を呼ぶか？

まず、 snoc が中で snoc を呼ぶ場合に最終的に得られるキューは lenr == 0 となっている。

一方で、tail が中で snoc を呼ぶ条件の 1 つが lenr >= 1 であるから、両方の条件を満たすキューは存在しないこととなる。